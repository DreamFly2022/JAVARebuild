# MySQL分布式事务

[toc]

# 一、为什么需要分布式事务

常用的分布式事务场景：

（1）进入分布式时代，我们数据库“横切竖割”进行拆分，在一个大的事务操作过程中，可能就会操作到几个不同的数据库实例的几个不同的表。这个时候我们就需要一种方案，解决不同数据库实例间的数据库一致性问题。

（2）对业务系统进行了服务化改造之后，各系统之间的访问走RPC，不是像以前那样走数据库了；

（3）有时候，是两个或多个服务用同一套数据库，有一个更大的系统同时调用这两个或多个服务，也会用到分布式事务；

## 二、如何实现分布式下的一致性

典型情况下是两个思路

1. 【强一致性事务】理想状态：直接想单机数据库事务一样，多个数据库自动通过某种协调机制，实现 了跨数据库节点的一致性。

   使用场景：要求严格的一致性，比如金融交易类业务。

2. 【柔性事务】一般情况：可以容忍一段时间的数据不一致，最终通过超时终止，调度补偿，等等 方式，实现数据的最终状态一致性。

   使用场景：准实时或非实时的处理，比如T+1的各类操作，或者电商类操作。（冲正）

数据库之外的事务。

1. 强一致性：XA

2. 弱一致性事务：柔性事务

   （1）不用事务，业务侧补偿冲正（比如：晚上跑数据，对数据进行修正。）；

   （2）所谓的柔性事务，使用一套事务框架保证最终一致的事务

**这两种都是在数据库基础上进一步做的封装和增强。**

## 三、XA分布式事务

### 3.1 XA分布式事务协议

- 基于第一个强一致的思路，就有了基于数据库本身支持的协议，XA分布式事务。

- XA整体设计思路可以概括为，如何在现有事务模型上微调扩展，实现分布式事务

> X/Open，即现在的 open group，是一个独立的组织，主要负责制定各种行 业技术标准。X/Open 组织主要由各大知名公司或者厂商进行支持，这些组 织不光遵循 X/Open 组织定义的行业技术标准，也参与到标准的制定。

（1）资源管理器（RM）：本地事务

这里的资源指的就是能执行本地事务的数据库。比如：单个本地的mysql数据库。

（2）全局的事务管理器（TM）

管理和协调事务。

（3）应用程序（AP）

三者之间的管理：

- 应用程序需要使用数据库，如果不是分布式事务，那就直接操作本地事务就可以了；
- 如果应用程序需要使用分布式事务，那就需要借助全局事务管理器（事务的边界、要做哪些操作）；
- 全局事务事务器来协调多个本地事务进行统一的提交或失败；

### 3.2 XA接口

XA和本地事务的操作流程很像。

本地事务的边界：begin........commit/rollback，中间的操作都在这个事务的上下文里。

- xa_start ：负责开启或者恢复一个事务分支

  启动一个XA事务

- xa_end： 负责取消当前线程与事务分支的关联

  表明事务中间的SQL操作执行完了。

- xa_prepare：询问 RM 是否准备好提交事务分支

  表明要开始做commit和rollback了。

- xa_commit：通知 RM 提交事务分支

  提交XA事务

- xa_rollback： 通知 RM 回滚事务分支

  回滚XA事务

- xa_recover : 需要恢复的 XA 事务

  因为多个本地事务间需要，协调，需要等，就出现了恢复事务的机制（重新做提交或回滚）。

XA有个中间状态。 单机事务不需要依赖外部资源，事务要么提交，要么回滚，没有第三种选择了。但XA不太一样，要等别的都准备好。这样就意味着，我开启一个事务，开启完了，通过xa_end 告诉mysql我事务中间的SQL操作都执行完了。

思考：为什么XA事务又叫两阶段事务？2PC

因为所有的SQL（insert、update、delete）是在xa_end之前执行的，多个本地的数据库都进行了xa_prepare后，这个时候大家都处于一个可提交的状态。这个时候再通过TM（全局事务管理器）通知大家都去做commit（或者中间出现了什么问题，让大家统一回滚），这样分布式事务就实现了。









