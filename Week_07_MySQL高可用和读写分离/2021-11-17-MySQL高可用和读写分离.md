# MySQL 高可用和读写分离

[toc]

##  一、从单机到集群

### 1.1 单机MySQL数据库到几个问题

随着数据量的增大，读写并发的增加，系统可用性要求的提升，单机 MySQL 面临：

1. 容量有限，难以扩容；

2. 读写压力，QPS 过大，特别是分析类需求会影响到业务事务；

   - QPS 每秒查询率。

   - TPS 吞吐量，指系统在单位时间内处理请求的数量

     > 一般业务系统，要求TPS能达到5k～8k

3. 可用性不足，宕机问题

   不可靠

### 1.2 单机MySQL到技术演进

（1）读写压力==》多机机群==》主从复制

（2）高可用===》故障转移==》MHA/MGR/Orchestrator

（3）容量问题=》数据库拆分=》分库分表

> 垂直拆分、水平拆分

**通过操作N个数据库，如何保证数据库多一致性？**

（通过上面的技术演进带来的副作用）

（4）一致性问题=》分布式事务=》XA/柔性事务

解决方案：分布式事务，

具体做法：XA/柔性事务

> 如果XA对性能影响太大，可以考虑用柔性事务

再往后就是分布式数据库了。

![MySQL技术演进](./photos/001MySQL技术演进.png)

## 二、MySQL的主从复制

### 2.1 核心

1. 主库写binlog；
2. 从库relay log；

> 2000年，MySQL 3.23.15版本引入了复制
>
> 2002年，MySQL 4.0.2版本分离 IO 和 SQL 线程，引入了 relay log
>
> 2010年，MySQL 5.5版本引入半同步复制
>
> 2016年，MySQL 在5.7.17中引入 InnoDB Group Replication



![MySQL主从复制](./photos/002MySQL主从复制.png)

### 2.2 binlog

binlog 的格式有三种形式：

（1）Row

第一种方式，记录行内容，非常精确，但可能会导致日志变得特别大。不仅包含需要改的信息，还包含上下文信息。

（2）Statement

第二种方式，记录SQL（insert、update、delete）。

（3）Mixed

第三种方式，混合上面两种形式。



怎么查看binlog？

mysql文件夹下，有很多类型mysql-bin.000005这样的文件，通过命令行：`mysqlbinlog -vv mysqlbin.000005`进行查看。

### 2.3 方案一，异步复制：传统主从复制

异步复制：传统主从复制--2000年，MySQL 3.23.15版本引入了 Replication

Primary-Secondary Replication 传统主从复制：

主库（Source）：执行SQL（execute）----->（在事务提交(commit)之前）记录binlog------>提交（commit）

从库（Replica1）：relay log（从主库拉取binlog，有偏移量，类似消息队列）----->应用(apply)--->binlog--->提交

**异步复制（这个都是异步的）：网络或机器故障，会造成数据不一致。**

![MySQL传统主从复制](./photos/003MySQL传统主从复制.png)

### 2.4 方案二，半同步复制，需要启用插件

半同步：不管有多少个从库在复制，每个事务只要有一个从库告诉我 它已经拿到了我发给它的log，这个时候主库就提交了。也就是说，主库把提交延迟到至少有一个从库拿到了我发给它的消息（ACK）。

> 保证Source和Replica最终一致性（保证至少有一个从库和主库是同步的）

![半同步复制](./photos/004半同步复制.png)

### 2.5 方案三：组复制，MySQL Group Replication（MGR）

组复制：基于分布式Paxos协议实现组复制，保证数据一致性。

通过协议的方式，保证主从一致。

![MySQL组复制](./photos/005MySQL组复制.png)

## 2.6 主从复制的演示:Ubuntu

[windows系统演示](./document/ms.md)

[从官网查询下载Ubuntu平台的mysql入口](https://cdn.mysql.com/archives/mysql-5.7/mysql-community-server_5.7.35-1ubuntu18.04_amd64.deb)

### （1）第一步，准备两个MySQL

```
# 创建用户组：
groupadd mysql 
#-r：创建无登录权限的账户
useradd -r -g mysql mysql

tar -zxvf mysql-5.7.35-linux-glibc2.12-x86_64.tar.gz -C /usr/local/
cd /usr/local/
mv mysql-5.7.35-linux-glibc2.12-x86_64 mysql-1
cp -r mysql-1 mysql-2
mkdir -p {mysql-1,mysql-2}/data

chown -R mysql:mysql /usr/local/{mysql-1,mysql-2}
chmod -R 755 /usr/local/{mysql-1,mysql-2}


mkdir -p /usr/local/{mysql-1,mysql-2}/{tmp,mysqld}
touch /usr/local/mysql-1/mysqld/mysqld.sock
touch /usr/local/mysql-1/mysqld/mysqld.pid

touch /usr/local/mysql-2/mysqld/mysqld.sock
touch /usr/local/mysql-2/mysqld/mysqld.pid
```

初始化数据库：

```
# 初始化第一个mysql服务
cd /usr/local/mysql-1/bin
## 下面这句，执行完之后，会在最后一行生成一个默认密码：SzypT/rra2a0
./mysqld --initialize --defaults-file=/usr/local/mysql-1/my.cnf  --user=mysql --datadir=/usr/local/mysql-1/data --basedir=/usr/local/mysql-1

./mysqld --defaults-file=/usr/local/mysql-1/my.cnf \
--basedir=/usr/local/mysql-1/ \
--datadir=/usr/local/mysql-1/data/ \
--user=mysql \
--initialize-insecure \
--ssl \
--explicit_defaults_for_timestamp \
--verbose



# 初始化第二个mysql服务
cd /usr/local/mysql-2/bin
## 下面这句，执行完之后，会在最后一行生成一个默认密码：Yh.M6GsEspe6
./mysqld --initialize  --defaults-file=/usr/local/mysql-2/my.cnf --user=mysql --datadir=/usr/local/mysql-2/data --basedir=/usr/local/mysql-2


./mysqld --defaults-file=/usr/local/mysql-2/my.cnf \
--basedir=/usr/local/mysql-2/ \
--datadir=/usr/local/mysql-2/data/ \
--user=mysql \
--initialize-insecure \
--ssl \
--explicit_defaults_for_timestamp \
--verbose



```

启动mysql并指定配置文件

`/usr/local/mysql-1/my.cnf`

```
[mysqld]
basedir=/usr/local/mysql-1/
tmpdir=/usr/local/mysql-1/tmp
datadir=/usr/local/mysql-1/data
socket=/usr/local/mysql-1/mysqld/mysqld.sock
pid-file=/usr/local/mysql-1/mysqld/mysqld.pid
port=3306
bind-address=127.0.0.1
server_id = 1

sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES 
log_bin=mysql-bin
binlog-format=Row
```

`/usr/local/mysql-2/my.cnf`

```
[mysqld]
basedir=/usr/local/mysql-2/
tmpdir=/usr/local/mysql-2/tmp
datadir=/usr/local/mysql-2/data
socket=/usr/local/mysql-2/mysqld/mysqld.sock
pid-file=/usr/local/mysql-2/mysqld/mysqld.pid
port = 3316
bind-address=127.0.0.1
server_id = 2

sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES 
log_bin=mysql-bin
binlog-format=Row
```

启动mysql服务

```
# 启动第一个mysql服务
cd /usr/local/mysql-1/bin
./mysqld --defaults-file=/usr/local/mysql-1/my.cnf --user=mysql

./mysqld --defaults-file=/usr/local/mysql-1/my.cnf --user=mysql

# 启动第二个mysql服务
cd /usr/local/mysql-2/bin
./mysqld --defaults-file=/usr/local/mysql-2/my.cnf --user=mysql
```

### （2）第二步，测试连接mysql，需要配置socket

```
# 登陆第一个mysql
mysql -S /usr/local/mysql-1/mysqld/mysqld.sock -hlocalhost -P3306 -uroot -p
## 重置密码
set password=password('root');

# 登陆mysql
mysql -S /usr/local/mysql-2/mysqld/mysqld.sock -hlocalhost -P3316 -uroot -p
## 重置密码
set password=password('root');
```

### （3）第三步：配置主库3306

登陆到主节点

> mysql -S /usr/local/mysql-1/mysqld/mysqld.sock -hlocalhost -P3306 -uroot -p

```mysql
mysql> CREATE USER 'repl'@'%' IDENTIFIED BY '123456';
Query OK, 0 rows affected (0.00 sec)

grant all on db.* TO repl;

mysql> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
Query OK, 0 rows affected (0.01 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.01 sec)

mysql> show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      991 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)



create schema db;
```



### （4） 第四步：配置从节点 3316

> mysql -S /usr/local/mysql-2/mysqld/mysqld.sock -hlocalhost -P3316 -uroot -p

```
mysql> CHANGE MASTER TO
    ->     MASTER_HOST='localhost',
    ->     MASTER_PORT = 3306,
    ->     MASTER_USER='repl',
    ->     MASTER_PASSWORD='123456',
    ->     MASTER_LOG_FILE='mysql-bin.000003',
    ->     MASTER_LOG_POS=991;
Query OK, 0 rows affected, 2 warnings (0.02 sec)


CHANGE MASTER TO
MASTER_HOST='localhost',
MASTER_PORT = 3306,
MASTER_USER='repl',
MASTER_PASSWORD='123456',
MASTER_LOG_FILE='mysql-bin.000002',
MASTER_LOG_POS=1341;

CHANGE MASTER TO
MASTER_HOST='localhost',
MASTER_PORT = 3306,
MASTER_USER='root',
MASTER_PASSWORD='root',
MASTER_LOG_FILE='mysql-bin.000002',
MASTER_LOG_POS=1341;
    
    
    
mysql> show schemas;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)

mysql> create schema db;
Query OK, 1 row affected (0.01 sec)
```

### （5）第五步：验证操作

#### 5.1在主库3306上创建表，并插入几条数据

```
mysql> use db;
Database changed
mysql> create table t1(id int);
Query OK, 0 rows affected (0.01 sec)

mysql> insert into t1(id) values(1),(2);
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

mysql> show tables;
+--------------+
| Tables_in_db |
+--------------+
| t1           |
+--------------+
1 row in set (0.00 sec)

mysql> select * from t1;
+------+
| id   |
+------+
|    1 |
|    2 |
+------+
2 rows in set (0.00 sec)
```

#### 5.2 在从库上查看数据同步情况

```
```

