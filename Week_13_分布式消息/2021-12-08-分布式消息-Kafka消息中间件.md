# 分布式消息：Kafka消息中间件

[toc]

## 一、什么是Kafka

Kafka 是一种分布式的，基于发布 / 订阅的消息系统

> 所有消息都是基于Topic。

kafka被设计的目标：

1. 持久化和性能；

    不管持久化多少数据，都不会影响其性能。但这不是绝对的。

2. 高吞吐率

   顺序写，无论是写还是读性能非常高。

3. 顺序

   保证消息传递到消费者那里，能够顺序传输。有序就可以保证业务上的有序。

4. 支持离线和实现数据处理

5. 支持水平扩展（与partition相关）

## 二、kafka的基本概念

 模拟在单台服务器上，启动三节点的kafka集群：

## 三、单机kafka

### 3.1 配置

修改`config/server.properties`:

```
打开 listeners=PLAINTEXT://localhost:9092
```

### 3.2 启动zookeeper和kafka服务

```
-- 启动zookeeper
nohup bin/zookeeper-server-start.sh config/zookeeper.properties 1>zookeeper.out 2>&1 &
-- 启动kafka
nohup bin/kafka-server-start.sh config/server.properties 1>kafka.out 2>&1 &
```

### 3.3 基本的操作命令

```
-- 查看topic列表
bin/kafka-topics.sh --zookeeper localhost:2181 --list 
-- 创建topic名称为 testk 
bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic testk --partitions 4 -replication-factor 1 
-- 查看topic的描述
bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic testk 
-- 在命令行 开启一个consumer
bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning -topic testk 
-- 在命令行 开启一个producer
bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic testk

-- 简单的性能测试
-- 测试生成者的性能
bin/kafka-producer-perf-test.sh --topic testk --num-records 100000 --record-size 1000 --throughput 2000 --producer-props bootstrap.servers=localhost:9092
-- 测试消费者的性能
bin/kafka-consumer-perf-test.sh --bootstrap-server localhost:9092 --topic testk -fetch-size 1048576 --messages 100000 --threads 1
```





## 四、kafka集群

### 4.1 配置

`kafka/` 文件夹下

```
cp config/server.properties kafka9001.properties
```

```
-rw-r--r--    1 lifei  staff  29975 12 16  2020 LICENSE
-rw-r--r--    1 lifei  staff    337 12 16  2020 NOTICE
drwxr-xr-x   36 lifei  staff   1152 12 16  2020 bin
drwxr-xr-x   17 lifei  staff    544 12 16  2020 config
-rw-r--r--    1 lifei  staff   7006 12 11 13:15 kafka9001.properties
-rw-r--r--    1 lifei  staff   7006 12 11 13:16 kafka9002.properties
-rw-r--r--    1 lifei  staff   7006 12 11 13:17 kafka9003.properties
drwxr-xr-x  103 lifei  staff   3296 12 16  2020 libs
drwxr-xr-x    3 lifei  staff     96 12 16  2020 site-docs
```



```
$ cat kafka9001.properties | grep -v '^$' | grep -v '^#'
broker.id=1   # 三个文件分别改为 1、2、3
listeners=PLAINTEXT://localhost:9001   # 三个文件分别改为 9001、9002、9003
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/tmp/kafka/kafka-logs1    # 三个文件分别改为 1、2、3
num.partitions=1
num.recovery.threads.per.data.dir=1
offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
zookeeper.connect=localhost:2181
zookeeper.connection.timeout.ms=18000
group.initial.rebalance.delay.ms=0
delete.topic.enable=true
message.max.bytes=5000000
replica.fetch.max.bytes=5000000
broker.list=localhost:9001,localhost:9002,localhost:9003
```



### 4.2 启动zookeeper和kafka

注意搭建kafka集群的时候，需要到zookeeper上，把之前zookeeper清空(否则启动后数据无法传递)：

```
-- 通过命令行进入zookeeper
./bin/zookeeper-shell.sh localhost:2181
-- 第一次执行 ls 命令的效果
ls /
[zookeeper]
```

启动zookeeper和kafka:

```
-- 启动 zookeeper
nohup bin/zookeeper-server-start.sh config/zookeeper.properties 1>zookeeper_nohup.out 2>&1 &
-- 启动 kafka 集群
nohup ./bin/kafka-server-start.sh ./kafka9001.properties 1>kafka9001.log 2>&1 &
nohup ./bin/kafka-server-start.sh ./kafka9002.properties 1>kafka9002.log 2>&1 &
nohup ./bin/kafka-server-start.sh ./kafka9003.properties 1>kafka9003.log 2>&1 &
```

###  4.3 基本的操作命令:

```
-- 通过命令行进入zookeeper
./bin/zookeeper-shell.sh localhost:2181
-- 第一次执行 ls 命令的效果
ls /
[zookeeper]

-- 查看topic列表
./bin/kafka-topics.sh --zookeeper localhost:2181 --list

-- 创建一个带有两个副本的topic
./bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic test32 --partitions 3 --replication-factor 2

-- 查看topic描述
./bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic test32

-- 启动一个消费者
./bin/kafka-console-consumer.sh --bootstrap-server localhost:9001,localhost:9002,localhost:9003  --from-beginning --topic test32


-- 启动一个生产者
./bin/kafka-console-producer.sh --bootstrap-server localhost:9001,localhost:9002,localhost:9003 --topic test32

-- 简单的生产者测试
bin/kafka-producer-perf-test.sh --topic test32 --num-records 100000 --record-size 1000 --throughput 2000 --producer-props bootstrap.servers=localhost:9002

-- 简单的消费者测试
bin/kafka-consumer-perf-test.sh --bootstrap-server localhost:9002 --topic test32 -fetch-size 1048576 --messages 100000 --threads 1

```



查看带有两个副本的topic描述：

```
$ ./bin/kafka-topics.sh --zookeeper localhost:2181 --describe --topic test32
Topic: test32	PartitionCount: 3	ReplicationFactor: 2	Configs:
	Topic: test32	Partition: 0	Leader: 1	Replicas: 1,2	Isr: 1,2
	Topic: test32	Partition: 1	Leader: 2	Replicas: 2,3	Isr: 2,3
	Topic: test32	Partition: 2	Leader: 3	Replicas: 3,1	Isr: 3,1
```



## 五、简单的生产者和消费者Java程序

开发一个[极简的Java程序来测试kafka集群]()：
