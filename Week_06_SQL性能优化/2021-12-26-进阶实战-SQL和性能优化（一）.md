# 进阶实战：SQL和性能优化

[toc]

## 一、回顾印象最深刻的点

1. 配置优化：query_cache_size、tmp_table_size

   [参数调优建议](https://help.aliyun.com/document_detail/63255.html?utm_content=g_1000230851&spm=5176.20966629.toubu.3.f2991ddcpxxvD1#title-zwl-lne-jae)

   ```sql
   适用版本：5.7、5.6、5.5
   默认值：3145728
   修改完后是否需要重启：否
   作用：该参数用于控制MySQL query cache的内存大小。如果MySQL开启query cache，在执行每一个query的时候会先锁住query cache，然后判断是否存在于query cache中，如果存在则直接返回结果，如果不存在，则再进行引擎查询等操作。同时，insert、update和delete这样的操作都会将query cahce失效掉，这种失效还包括结构或者索引的任何变化。但是cache失效的维护代价较高，会给MySQL带来较大的压力。所以，当数据库不会频繁更新时，query cache是很有用的，但如果写入操作非常频繁并集中在某几张表上，那么query cache lock的锁机制就会造成很频繁的锁冲突，对于这一张表的写和读会互相等待query cache lock解锁，从而导致select的查询效率下降。
   现象：数据库中有大量的连接状态为checking query cache for query、Waiting for query cache lock、storing result in query cache。
   修改建议：(阿里云数据库 RDS)默认是关闭query cache功能的，如果您的实例打开了query cache，当出现上述情况后可以关闭query cache。
   ```

   ```
   tmp_table_size
   适用版本：8.0、5.7、5.6、5.5
   默认值：2097152
   修改完后是否需要重启：否
   作用：该参数用于决定内部内存临时表的最大值，每个线程都要分配，实际起限制作用的是tmp_table_size和max_heap_table_size的最小值。如果内存临时表超出了限制，MySQL就会自动地把它转化为基于磁盘的MyISAM表。优化查询语句的时候，要避免使用临时表，如果实在避免不了的话，要保证这些临时表是存在内存中的。
   现象：如果复杂的SQL语句中包含了group by、distinct等不能通过索引进行优化而使用了临时表，则会导致SQL执行时间加长。
   修改建议：如果应用中有很多group by、distinct等语句，同时数据库有足够的内存，可以增大tmp_table_size（max_heap_table_size）的值，以此来提升查询性能。
   ```

2. 如何设计表：char和varchar；

3. 索引的存储：

   - hash索引和B+tree
   - 索引失效

## 二、进阶实践

### 2.1 思考在实际项目中的应用

1、（选做）：基于课程中的设计原则和最佳实践，分析是否可以将自己负责的业务系统 进行数据库设计或是数据库服务器方面的优化

### 2.2 设计一套简单的表结构

2、（必做）：基于电商交易场景（用户、商品、订单），设计一套简单的表结构，提交 DDL 的 SQL 文件到 Github（后面2周的作业依然要是用到这个表结构）

### 2.3 安装关系型数据库

3、（选做）：尽可能多的从“常见关系数据库”中列的清单，安装运行，并使用上一题的 SQL 测试简单的增删改查。

### 2.4 测试100万订单数据

4、（选做）：基于上一题，尝试对各个数据库测试100万订单数据的增删改查性能。

### 2.5 测试mysql不同引擎

5、（选做）：尝试对 MySQL 不同引擎下测试100万订单数据的增删改查性能。

### 2.6 测试导入导出的性能测试

6、（选做）：模拟1000万订单数据，测试不同方式下导入导出（数据备份还原） MySQL 的速度，包括 jdbc 程序处理和命令行处理。思考和实践，如何提升处理效率。

###  2.7 尝试使用不同的数据库连接池

7、（选做）：对 MySQL 配置不同的数据库连接池（DBCP、C3P0、Druid、Hikari）， 测试增删改查100万次，对比性能，生成报告。